---
title: Custom Rules
description: Create custom detection rules with the KoreShield Rules DSL for tailored security policies
published: true
featured: true
---

# Custom Rules

KoreShield's Rules DSL (Domain-Specific Language) allows you to create custom detection rules tailored to your specific security requirements.

## Overview

Custom rules enable you to:

- **Extend** built-in detection patterns
- **Create** domain-specific threat detection
- **Customize** sensitivity per use case
- **Block** application-specific threats
- **Allow** known-safe patterns

---

## Rules DSL Syntax

### Basic Rule Structure

```yaml
rules:
  - id: rule_001
    name: "Block Crypto Addresses"
    description: "Prevent cryptocurrency address extraction"
    
    # Pattern matching
    pattern: "\\b[13][a-km-zA-HJ-NP-Z1-9]{25,34}\\b"
    
    # Action to take
    action: block
    
    # Confidence score (0.0 - 1.0)
    confidence: 1.0
    
    # Severity level
    severity: high
    
    # Attack type classification
    type: data_exfiltration
    
    # Enable/disable rule
    enabled: true
```

### Pattern Types

#### Regex Patterns
```yaml
rules:
  - id: rule_regex
    name: "Email Address Detection"
    pattern: "\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b"
    pattern_type: regex
    action: warn
```

#### Exact Match
```yaml
rules:
  - id: rule_exact
    name: "Block Specific Phrase"
    pattern: "ignore previous instructions"
    pattern_type: exact
    case_sensitive: false
    action: block
```

#### Contains
```yaml
rules:
  - id: rule_contains
    name: "Flag Internal Keywords"
    pattern: ["confidential", "internal use", "do not share"]
    pattern_type: contains_any
    action: warn
```

#### Semantic Match
```yaml
rules:
  - id: rule_semantic
    name: "Detect Jailbreak Attempts"
    pattern: "attempts to bypass safety guidelines or content policies"
    pattern_type: semantic
    similarity_threshold: 0.85
    action: block
```

### Conditional Logic

#### Simple Conditions
```yaml
rules:
  - id: rule_conditional
    name: "Block High-Risk SQL"
    condition: >
      input.contains("DROP") AND 
      input.contains("TABLE") AND
      confidence > 0.9
    action: block
```

#### Complex Conditions
```yaml
rules:
  - id: rule_complex
    name: "Time-Based Sensitivity"
    condition: >
      (hour >= 18 OR hour <= 6) AND
      (attack_type IN ["prompt_injection", "jailbreak"]) AND
      confidence > 0.70
    action: block
    
  - id: rule_geographic
    name: "Geographic Restrictions"
    condition: >
      country_code NOT IN ["US", "CA", "UK", "EU"] AND
      contains_pii == true
    action: block
```

### Variables & Context

Access request context in rules:

```yaml
rules:
  - id: rule_context
    name: "Context-Aware Rule"
    condition: >
      request.tenant_tier == "free" AND
      request.user.role != "admin" AND
      input.length > 1000
    action: rate_limit
```

**Available Context Variables:**

| Variable | Type | Description |
|----------|------|-------------|
| `input` | string | User input text |
| `input.length` | int | Length of input |
| `confidence` | float | Detection confidence (0-1) |
| `attack_type` | string | Detected attack type |
| `severity` | string | Threat severity level |
| `tenant_id` | string | Tenant identifier |
| `user.id` | string | User identifier |
| `user.role` | string | User role |
| `request.ip` | string | Request IP address |
| `request.country` | string | Request country code |
| `hour` | int | Current hour (0-23) |
| `day_of_week` | string | Day name (Monday-Sunday) |
| `contains_pii` | bool | PII detected in input |

---

## Rule Categories

### Pattern-Based Rules

Detect specific patterns:

```yaml
rules:
  # SQL Injection
  - id: sql_001
    name: "SQL Comment Injection"
    pattern: "--\\s*$|#\\s*$|/\\*.*\\*/"
    type: sql_injection
    action: block
    confidence: 0.95
    
  # Command Injection
  - id: cmd_001
    name: "Shell Command Injection"
    pattern: "([;&|]|`|\\$\\(|\\$\\{)\\s*(rm|cat|wget|curl|nc|bash|sh)"
    type: code_injection
    action: block
    confidence: 0.98
    
  # API Key Pattern
  - id: api_001
    name: "AWS Access Key"
    pattern: "AKIA[0-9A-Z]{16}"
    type: data_exfiltration
    action: block
    confidence: 1.0
    
  # Credit Card
  - id: pii_001
    name: "Credit Card Number"
    pattern: "\\b\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}\\b"
    type: pii_extraction
    action: block
    confidence: 0.90
```

### Behavioral Rules

Detect suspicious behavior:

```yaml
rules:
  # Rapid Fire Requests
  - id: behavior_001
    name: "Rapid Repeated Requests"
    condition: >
      request_count_last_minute > 100 AND
      unique_inputs_percentage < 20
    action: rate_limit
    duration: 300  # 5 minutes
    
  # Account Enumeration
  - id: behavior_002
    name: "Account Enumeration Attempt"
    condition: >
      error_count_last_hour > 50 AND
      pattern.matches("user not found|invalid user|account.*not exist")
    action: block
    alert: true
    
  # Credential Stuffing
  - id: behavior_003
    name: "Credential Stuffing Detection"
    condition: >
      failed_auth_attempts > 10 AND
      time_window_minutes < 5
    action: block
    alert: critical
```

### Content-Based Rules

Analyze content characteristics:

```yaml
rules:
  # Excessive Length
  - id: content_001
    name: "Excessive Input Length"
    condition: >
      input.length > 10000
    action: warn
    message: "Input exceeds recommended length"
    
  # Unusual Characters
  - id: content_002
    name: "Unusual Character Patterns"
    condition: >
      input.unicode_category("Control") > 10 OR
      input.contains("\\x00") OR
      input.contains("\\uFEFF")
    action: sanitize
    
  # Language Detection
  - id: content_003
    name: "Unexpected Language"
    condition: >
      detected_language NOT IN ["en", "es", "fr", "de"] AND
      confidence > 0.9
    action: warn
```

### Composite Rules

Combine multiple conditions:

```yaml
rules:
  - id: composite_001
    name: "High-Risk Transaction"
    description: "Multiple risk factors present"
    conditions:
      - name: "New Account"
        check: account_age_days < 7
        weight: 0.3
        
      - name: "High-Value Transaction"
        check: transaction_value > 10000
        weight: 0.4
        
      - name: "Unusual Location"
        check: country_code != user.usual_country
        weight: 0.2
        
      - name: "After Hours"
        check: hour < 6 OR hour > 22
        weight: 0.1
    
    # Action when combined score > threshold
    threshold: 0.7
    action: challenge
    mfa_required: true
```

---

## Rule Actions

### Available Actions

```yaml
actions:
  # Block the request
  block:
    response:
      status_code: 403
      message: "Request blocked for security reasons"
    log: true
    alert: false
    
  # Allow with warning
  warn:
    response:
      status_code: 200
      warning_header: "X-KoreShield-Warning: Potential threat detected"
    log: true
    alert: false
    
  # Challenge user
  challenge:
    type: captcha  # or mfa, security_question
    max_attempts: 3
    timeout_seconds: 300
    
  # Sanitize input
  sanitize:
    method: strip  # strip, escape, encode
    patterns: ["<script>", "javascript:", "onerror="]
    fallback_action: block
    
  # Rate limit
  rate_limit:
    duration_seconds: 3600
    max_requests: 10
    scope: user  # user, ip, tenant
    
  # Redirect
  redirect:
    url: "https://example.com/security-notice"
    status_code: 302
    
  # Custom webhook
  webhook:
    url: "https://your-api.com/security/alert"
    method: POST
    headers:
      Authorization: "Bearer ${WEBHOOK_TOKEN}"
    body:
      event: "rule_triggered"
      rule_id: "${rule.id}"
      input: "${input}"
```

### Action Chains

Execute multiple actions:

```yaml
rules:
  - id: chain_001
    name: "Alert and Block"
    pattern: ".*DROP TABLE.*"
    actions:
      - type: alert
        channel: slack
        priority: critical
      - type: block
        response:
          message: "SQL injection attempt blocked"
      - type: webhook
        url: "https://siem.company.com/events"
```

---

## Rule Testing

### Dry Run Mode

Test rules without enforcement:

```yaml
rules:
  - id: test_rule
    name: "Testing New Rule"
    pattern: "experimental pattern"
    action: block
    dry_run: true  # Only logs, doesn't enforce
```

### Testing API

```python
from koreshield_sdk import KoreShieldClient

client = KoreShieldClient(api_key="your-api-key")

# Test a rule
result = client.test_rule(
    rule_id="rule_001",
    test_input="bitcoin:1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa",
    context={
        "tenant_id": "tenant_test",
        "user_role": "developer"
    }
)

print(f"Matched: {result['matched']}")
print(f"Action: {result['action']}")
print(f"Confidence: {result['confidence']}")
```

### Test Cases

```yaml
test_cases:
  - rule_id: rule_001
    name: "Bitcoin Address Detection"
    inputs:
      - text: "Send payment to 1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa"
        expected_match: true
        expected_action: block
        
      - text: "This is a normal transaction"
        expected_match: false
        expected_action: allow
        
      - text: "Invalid address: 123456789"
        expected_match: false
        expected_action: allow
```

Run tests:

```bash
# Test all rules
koreshield rules test --all

# Test specific rule
koreshield rules test --rule-id rule_001

# Test with coverage report
koreshield rules test --coverage
```

---

## Rule Management

### Organizing Rules

```yaml
rule_groups:
  - id: group_pii
    name: "PII Protection Rules"
    description: "Rules to prevent PII extraction"
    rules:
      - rule: pii_001  # Credit cards
      - rule: pii_002  # SSNs
      - rule: pii_003  # Phone numbers
      - rule: pii_004  # Email addresses
    enabled: true
    
  - id: group_injection
    name: "Injection Attack Rules"
    description: "SQL and command injection prevention"
    rules:
      - rule: sql_001
      - rule: sql_002
      - rule: cmd_001
    enabled: true
```

### Rule Inheritance

Create rule templates:

```yaml
rule_templates:
  - id: template_api_key
    name: "API Key Detection Template"
    pattern_format: "{prefix}[A-Za-z0-9]{{{key_length}}}"
    action: block
    confidence: 1.0
    
rules:
  # Use template for different API key types
  - id: aws_key
    template: template_api_key
    params:
      prefix: "AKIA"
      key_length: 16
      
  - id: stripe_key
    template: template_api_key
    params:
      prefix: "sk_live_"
      key_length: 24
```

### Versioning

Track rule versions:

```yaml
rules:
  - id: rule_001
    version: "2.0.0"
    changelog:
      - version: "2.0.0"
        date: "2026-02-01"
        changes: "Improved pattern accuracy"
      - version: "1.0.0"
        date: "2026-01-01"
        changes: "Initial release"
    
    # Current pattern (v2.0.0)
    pattern: "improved-regex-pattern"
```

---

## Advanced Features

### Machine Learning Integration

Enhance rules with ML:

```yaml
rules:
  - id: ml_enhanced_001
    name: "ML-Enhanced Phishing Detection"
    
    # Base pattern matching
    pattern: ".*(click here|verify account|urgent action).*"
    
    # ML classification
    ml_model: "phishing_classifier_v2"
    ml_threshold: 0.85
    
    # Combined decision
    action: block
    condition: >
      pattern_matches OR ml_confidence > ml_threshold
```

### Dynamic Rules

Rules that adapt over time:

```yaml
rules:
  - id: dynamic_001
    name: "Adaptive Threshold Rule"
    pattern: "suspicious pattern"
    
    # Base confidence
    confidence: 0.75
    
    # Adjust based on metrics
    adaptive:
      enabled: true
      metric: false_positive_rate
      target: 0.01  # 1% FP rate
      adjustment_range: [0.65, 0.85]
      recalculation_interval: 24h
```

### A/B Testing

Test rule variations:

```yaml
ab_tests:
  - name: "Stricter vs Balanced Threshold"
    rules:
      - id: rule_001_strict
        pattern: "test pattern"
        confidence: 0.85
        traffic_percent: 50
        
      - id: rule_001_balanced
        pattern: "test pattern"
        confidence: 0.70
        traffic_percent: 50
    
    metrics:
      - false_positive_rate
      - false_negative_rate
      - user_satisfaction
    
    duration_days: 7
    auto_promote_winner: true
```

---

## Best Practices

### Start Simple

Begin with basic rules:

```yaml
# Good: Simple and clear
rules:
  - id: simple_001
    name: "Block SQL DROP Commands"
    pattern: "DROP\\s+TABLE"
    action: block

# Avoid: Overly complex initially
rules:
  - id: complex_001
    pattern: "(?i)(DROP|ALTER|TRUNCATE)\\s+(TABLE|DATABASE).*"
    condition: >
      (confidence > 0.85 AND hour >= 18) OR
      (user.role != 'admin' AND tenant.tier == 'free')
    # Too much complexity upfront
```

### Test Thoroughly

Always test before deployment:

```bash
# Test rule with sample inputs
koreshield rules test --rule-id rule_001 --samples test_data.json

# Run in dry-run mode first
koreshield rules deploy --rule-id rule_001 --dry-run

# Monitor for false positives
koreshield rules monitor --rule-id rule_001 --duration 24h
```

### Document Rules

Add clear documentation:

```yaml
rules:
  - id: documented_rule
    name: "Well Documented Rule"
    description: "Detailed explanation of what this rule does"
    
    # Why this rule exists
    rationale: "Prevents extraction of cryptocurrency addresses from company chatbot"
    
    # Examples
    examples:
      match:
        - "Send BTC to 1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa"
        - "My wallet: bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh"
      no_match:
        - "I'm interested in learning about cryptocurrency"
        - "What is blockchain technology?"
    
    # Who to contact
    owner: "security-team@company.com"
    last_updated: "2026-02-01"
```

### Monitor Performance

Track rule effectiveness:

```yaml
rules:
  - id: monitored_rule
    metrics:
      - match_rate
      - false_positive_rate
      - false_negative_rate
      - avg_latency_ms
    
    # Auto-disable if performance degrades
    auto_disable:
      enabled: true
      conditions:
        - false_positive_rate > 0.05
        - avg_latency_ms > 100
      notification: security-team@company.com
```

### Use Rule Precedence

Order matters:

```yaml
rules:
  # Allowlist first (highest priority)
  - id: allowlist_001
    name: "Allow QA Testing Patterns"
    pattern: "test_.*_qa"
    action: allow
    priority: 100
    
  # Specific rules next
  - id: specific_001
    name: "Block Specific Threat"
    pattern: "very specific pattern"
    action: block
    priority: 50
    
  # General rules last (lowest priority)
  - id: general_001
    name: "General SQL Injection"
    pattern: ".*SQL.*"
    action: warn
    priority: 10
```

---

## API Reference

### Create Rule

```bash
curl -X POST https://api.koreshield.com/v1/rules \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Custom Rule",
    "pattern": "malicious pattern",
    "action": "block",
    "confidence": 0.9,
    "enabled": true
  }'
```

### Update Rule

```bash
curl -X PUT https://api.koreshield.com/v1/rules/rule_001 \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "confidence": 0.85,
    "reason": "Reducing false positives"
  }'
```

### List Rules

```bash
curl -X GET https://api.koreshield.com/v1/rules \
  -H "Authorization: Bearer YOUR_API_KEY"
```

### Test Rule

```bash
curl -X POST https://api.koreshield.com/v1/rules/rule_001/test \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "input": "test input string",
    "context": {
      "tenant_id": "tenant_123"
    }
  }'
```

---

## Examples Repository

Check out our rules repository:

- **GitHub**: [github.com/koreshield/rules](https://github.com/koreshield/rules)
- **Community Rules**: User-contributed detection rules
- **Industry-Specific**: Healthcare, Finance, Legal templates
- **Compliance**: HIPAA, PCI-DSS, GDPR rule sets

---

## Related Documentation

- [Attack Detection](/docs/attack-detection) - Built-in detection patterns
- [Policy Engine](/docs/policy-engine) - Policy configuration
- [API Reference](/docs/api-reference) - Complete API documentation
- [Examples](/docs/examples) - Real-world rule examples

---

## Support

Need help with custom rules?

- **Discord**: [discord.gg/koreshield](https://discord.gg/koreshield)
- **GitHub**: [github.com/koreshield/koreshield/issues](https://github.com/koreshield/koreshield/issues)
- **Email**: support@koreshield.com
- **Documentation**: [docs.koreshield.com](https://docs.koreshield.com)
